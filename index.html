<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üèì VR Ping Pong</title>
  <meta name="description" content="VR Table Tennis for Oculus Quest">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    #hud {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 24px;
      z-index: 999;
      background: rgba(0,0,0,0.6);
      padding: 10px 30px;
      border-radius: 10px;
    }
    #info {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #fff;
      font-family: Arial, sans-serif;
      font-size: 14px;
      z-index: 999;
      background: rgba(0,0,0,0.7);
      padding: 10px 20px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="hud">YOU: 0 ‚Äî CPU: 0</div>
  <div id="info">üéÆ Right hand = paddle | TRIGGER = serve</div>

  <a-scene>
    <!-- Sky & Floor -->
    <a-sky color="#1a1a2e"></a-sky>
    <a-plane rotation="-90 0 0" width="20" height="20" color="#16213e"></a-plane>
    
    <!-- Lights -->
    <a-light type="ambient" intensity="0.4"></a-light>
    <a-light type="directional" intensity="0.7" position="2 8 4"></a-light>

    <!-- Table -->
    <a-entity id="table" position="0 0.76 -1.5">
      <a-box width="1.525" height="0.03" depth="2.74" color="#1b5e20"></a-box>
      <a-box position="0 0.016 0" width="0.02" depth="2.74" height="0.001" color="#fff"></a-box>
      <a-box position="0 0.016 0" width="1.525" depth="0.02" height="0.001" color="#fff"></a-box>
      <a-box position="0 0.08 0" width="1.7" height="0.15" depth="0.01" color="#333" opacity="0.8"></a-box>
      <a-box position="0.65 -0.38 1.2" width="0.05" height="0.76" depth="0.05" color="#444"></a-box>
      <a-box position="-0.65 -0.38 1.2" width="0.05" height="0.76" depth="0.05" color="#444"></a-box>
      <a-box position="0.65 -0.38 -1.2" width="0.05" height="0.76" depth="0.05" color="#444"></a-box>
      <a-box position="-0.65 -0.38 -1.2" width="0.05" height="0.76" depth="0.05" color="#444"></a-box>
    </a-entity>

    <!-- Ball -->
    <a-sphere id="ball" radius="0.02" color="#ff9800" position="0 1.5 -0.5"></a-sphere>

    <!-- CPU Paddle -->
    <a-entity id="cpu-paddle" position="0 0.95 -3.2">
      <a-cylinder radius="0.012" height="0.10" color="#8B4513" position="0 -0.05 0"></a-cylinder>
      <a-cylinder radius="0.08" height="0.015" color="#1565c0" rotation="90 0 0"></a-cylinder>
    </a-entity>

    <!-- Desktop paddle (hidden in VR) -->
    <a-entity id="desktop-paddle" position="0 1 0.2">
      <a-cylinder radius="0.012" height="0.10" color="#8B4513" position="0 -0.05 0"></a-cylinder>
      <a-cylinder radius="0.08" height="0.015" color="#c62828" rotation="90 0 0"></a-cylinder>
    </a-entity>

    <!-- Score in VR -->
    <a-text id="vr-score" value="YOU: 0 ‚Äî CPU: 0" position="0 2.2 -1.5" align="center" color="#fff" width="4"></a-text>
    <a-text id="vr-msg" value="TRIGGER = Serve" position="0 1.9 -1.5" align="center" color="#4fc3f7" width="3"></a-text>

    <!-- Camera Rig -->
    <a-entity id="rig" position="0 0 1">
      <a-camera></a-camera>
      
      <!-- RIGHT HAND with paddle as child! -->
      <a-entity id="rhand"
                oculus-touch-controls="hand: right; model: false"
                vive-controls="hand: right"
                windows-motion-controls="hand: right">
        <!-- PADDLE DIRECTLY ATTACHED TO CONTROLLER -->
        <a-entity id="vr-paddle" rotation="-90 0 0" position="0 0 -0.05">
          <a-cylinder radius="0.012" height="0.10" color="#8B4513" position="0 -0.07 0"></a-cylinder>
          <a-cylinder radius="0.08" height="0.015" color="#c62828"></a-cylinder>
        </a-entity>
      </a-entity>
      
      <a-entity oculus-touch-controls="hand: left; model: false"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    let pScore = 0, cScore = 0;
    let ballV = {x:0, y:0, z:0};
    let state = 'wait'; // wait, play
    let lastHit = '';
    let inVR = false;
    
    const G = -9.8, TABLE_Y = 0.775, TABLE_Z = -1.5;
    
    let ball, cpuPaddle, desktopPaddle, vrPaddle, rhand;
    
    document.querySelector('a-scene').addEventListener('loaded', init);
    
    function init() {
      ball = document.getElementById('ball');
      cpuPaddle = document.getElementById('cpu-paddle');
      desktopPaddle = document.getElementById('desktop-paddle');
      vrPaddle = document.getElementById('vr-paddle');
      rhand = document.getElementById('rhand');
      
      const scene = document.querySelector('a-scene');
      scene.addEventListener('enter-vr', () => { 
        inVR = true; 
        desktopPaddle.setAttribute('visible', false);
      });
      scene.addEventListener('exit-vr', () => { 
        inVR = false; 
        desktopPaddle.setAttribute('visible', true);
      });
      
      // Controller events
      rhand.addEventListener('triggerdown', serve);
      rhand.addEventListener('gripdown', serve);
      rhand.addEventListener('abuttondown', serve);
      rhand.addEventListener('bbuttondown', serve);
      
      // Desktop controls
      document.addEventListener('keydown', e => { if(e.code==='Space') serve(); });
      document.addEventListener('click', serve);
      document.addEventListener('mousemove', e => {
        if (!inVR) {
          const x = (e.clientX / window.innerWidth - 0.5) * 1.4;
          const y = 0.85 + (1 - e.clientY / window.innerHeight) * 0.4;
          desktopPaddle.object3D.position.set(x, y, 0.2);
        }
      });
      
      loop();
    }
    
    function serve() {
      if (state !== 'wait') return;
      state = 'play';
      lastHit = 'p';
      
      // Get paddle position
      let px, py, pz;
      if (inVR) {
        const wp = new THREE.Vector3();
        vrPaddle.object3D.getWorldPosition(wp);
        px = wp.x; py = wp.y; pz = wp.z;
      } else {
        const p = desktopPaddle.object3D.position;
        px = p.x; py = p.y; pz = p.z;
      }
      
      ball.object3D.position.set(px, py + 0.15, pz - 0.1);
      ballV = { x: (Math.random()-0.5)*2, y: 2.5, z: -5 };
      setMsg('');
    }
    
    function loop() {
      if (state === 'play') {
        updateBall();
        updateCPU();
        checkHit();
      }
      requestAnimationFrame(loop);
    }
    
    function updateBall() {
      const p = ball.object3D.position;
      const dt = 0.016;
      
      ballV.y += G * dt;
      p.x += ballV.x * dt;
      p.y += ballV.y * dt;
      p.z += ballV.z * dt;
      
      // Table bounce
      if (p.y < TABLE_Y && p.z > -2.87 && p.z < -0.13 && Math.abs(p.x) < 0.76) {
        p.y = TABLE_Y;
        ballV.y = Math.abs(ballV.y) * 0.8;
      }
      
      // Net
      if (Math.abs(p.z - TABLE_Z) < 0.03 && p.y < TABLE_Y + 0.15) {
        ballV.z *= -0.5;
      }
      
      // Out
      if (p.y < 0 || Math.abs(p.x) > 2.5 || p.z > 2 || p.z < -5) {
        score(p.z > TABLE_Z ? 'c' : 'p');
      }
    }
    
    function updateCPU() {
      const bp = ball.object3D.position;
      const cp = cpuPaddle.object3D.position;
      
      if (ballV.z < 0) {
        const t = Math.max(0.1, (cp.z - bp.z) / -ballV.z);
        const tx = Math.max(-0.6, Math.min(0.6, bp.x + ballV.x * t * 0.5));
        cp.x += (tx - cp.x) * 0.08;
      }
      cp.y = 0.95 + Math.sin(Date.now()/300) * 0.02;
    }
    
    function checkHit() {
      const bp = ball.object3D.position;
      
      // Player paddle (VR or desktop)
      let pp;
      if (inVR) {
        pp = new THREE.Vector3();
        vrPaddle.object3D.getWorldPosition(pp);
      } else {
        pp = desktopPaddle.object3D.position;
      }
      
      const distP = Math.hypot(bp.x - pp.x, bp.y - pp.y, bp.z - pp.z);
      if (distP < 0.1 && lastHit !== 'p') {
        hit('p', pp);
      }
      
      // CPU paddle
      const cp = cpuPaddle.object3D.position;
      const distC = Math.hypot(bp.x - cp.x, bp.y - cp.y, bp.z - cp.z);
      if (distC < 0.1 && lastHit !== 'c') {
        hit('c', cp);
      }
    }
    
    function hit(who, paddle) {
      lastHit = who;
      const bp = ball.object3D.position;
      const ox = (bp.x - paddle.x) * 15;
      const dir = who === 'p' ? -1 : 1;
      
      ballV = { x: ox + (Math.random()-0.5)*2, y: 2 + Math.random(), z: dir * (5 + Math.random()*2) };
      
      ball.setAttribute('color', who === 'p' ? '#4caf50' : '#f44336');
      setTimeout(() => ball.setAttribute('color', '#ff9800'), 100);
    }
    
    function score(winner) {
      state = 'wait';
      if (winner === 'p') pScore++; else cScore++;
      updateHUD();
      resetBall();
      
      if (pScore >= 11 || cScore >= 11) {
        setMsg(pScore > cScore ? 'üèÜ YOU WIN!' : 'üò¢ CPU WINS');
        setTimeout(() => { pScore = cScore = 0; updateHUD(); setMsg('TRIGGER = Serve'); }, 3000);
      } else {
        setMsg('TRIGGER = Serve');
      }
    }
    
    function resetBall() {
      ball.object3D.position.set(0, 1.5, -0.5);
      ballV = {x:0, y:0, z:0};
      lastHit = '';
    }
    
    function updateHUD() {
      const t = `YOU: ${pScore} ‚Äî CPU: ${cScore}`;
      document.getElementById('hud').textContent = t;
      document.getElementById('vr-score').setAttribute('value', t);
    }
    
    function setMsg(m) {
      document.getElementById('vr-msg').setAttribute('value', m);
    }
  </script>
</body>
</html>
