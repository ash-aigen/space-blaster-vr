<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üèì VR Controller Test</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <style>
    #debug { position:fixed; top:10px; left:10px; color:#0f0; font:12px monospace; background:rgba(0,0,0,0.8); padding:10px; z-index:9999; }
  </style>
</head>
<body>
  <div id="debug">Loading...</div>

  <a-scene webxr="requiredFeatures: local-floor">
    <a-sky color="#1a1a2e"></a-sky>
    <a-plane rotation="-90 0 0" width="10" height="10" color="#16213e"></a-plane>
    <a-light type="ambient" intensity="0.6"></a-light>
    <a-light type="directional" intensity="0.5" position="1 3 2"></a-light>

    <!-- Reference: A box at origin -->
    <a-box position="0 0.5 -1" width="0.2" height="0.2" depth="0.2" color="#888"></a-box>
    <a-text value="Origin (0,0.5,-1)" position="0 0.9 -1" align="center" color="#fff" width="2"></a-text>

    <!-- Ball - will drop from controller on trigger -->
    <a-sphere id="ball" radius="0.05" color="#ff9800" position="0 2 -1">
      <a-light type="point" color="#ff9800" intensity="0.3" distance="1"></a-light>
    </a-sphere>

    <!-- GREEN = Raw controller position (gripSpace) -->
    <a-sphere id="grip-marker" radius="0.03" color="#00ff00" position="0 1 0"></a-sphere>
    
    <!-- RED = Paddle (should match green) -->
    <a-box id="paddle" width="0.12" height="0.12" depth="0.02" color="#c62828" position="0 1 0"></a-box>

    <!-- Debug text in VR -->
    <a-text id="vr-debug" value="Enter VR..." position="0 1.8 -1" align="center" color="#0f0" width="3"></a-text>
    <a-text id="vr-instructions" value="TRIGGER = drop ball\nGRIP = reset" position="0 1.5 -1" align="center" color="#4fc3f7" width="2.5"></a-text>

    <!-- Camera -->
    <a-entity position="0 0 0">
      <a-camera></a-camera>
    </a-entity>
  </a-scene>

  <script>
    const debugEl = document.getElementById('debug');
    const vrDebugEl = document.getElementById('vr-debug');
    
    function log(msg) {
      debugEl.textContent = msg;
      if (vrDebugEl) vrDebugEl.setAttribute('value', msg);
      console.log(msg);
    }
    
    // State
    let inVR = false;
    let xrSession = null;
    let xrRefSpace = null;
    let rightController = null;
    let ballDropped = false;
    let ballVelY = 0;
    
    // Elements
    let scene, renderer, gripMarker, paddle, ball;
    
    function init() {
      scene = document.querySelector('a-scene');
      if (!scene?.hasLoaded) {
        scene?.addEventListener('loaded', init);
        setTimeout(init, 100);
        return;
      }
      
      gripMarker = document.getElementById('grip-marker');
      paddle = document.getElementById('paddle');
      ball = document.getElementById('ball');
      renderer = scene.renderer;
      
      scene.addEventListener('enter-vr', onEnterVR);
      scene.addEventListener('exit-vr', () => { inVR = false; xrSession = null; });
      
      log('Ready! Enter VR');
    }
    
    function onEnterVR() {
      inVR = true;
      log('Entered VR...');
      
      xrSession = renderer.xr?.getSession?.();
      if (!xrSession) { log('No XR session!'); return; }
      
      xrSession.requestReferenceSpace('local-floor')
        .then(space => { xrRefSpace = space; log('Got refspace'); })
        .catch(() => xrSession.requestReferenceSpace('local').then(s => { xrRefSpace = s; }));
      
      // Find controller
      function findController() {
        for (const src of xrSession.inputSources) {
          if (src.handedness === 'right' && src.gripSpace) {
            rightController = src;
            log('Controller found!');
            return;
          }
        }
        log(`Controllers: ${xrSession.inputSources.length}, waiting for right...`);
      }
      
      findController();
      xrSession.addEventListener('inputsourceschange', findController);
      
      // TRIGGER = drop ball
      xrSession.addEventListener('selectstart', (e) => {
        log(`SELECT from ${e.inputSource?.handedness || 'unknown'}`);
        dropBall();
      });
      xrSession.addEventListener('select', (e) => {
        log(`SELECT-end from ${e.inputSource?.handedness || 'unknown'}`);
      });
      
      // GRIP = also drop ball (backup)
      xrSession.addEventListener('squeezestart', (e) => {
        log(`SQUEEZE from ${e.inputSource?.handedness || 'unknown'}`);
        dropBall();
      });
      
      // A/B buttons via gamepad polling
      log('Listening for buttons...');
    }
    
    function dropBall() {
      if (!ball || !rightController) return;
      
      // Get current controller position
      const frame = renderer.xr?.getFrame?.();
      if (!frame || !xrRefSpace) return;
      
      const pose = frame.getPose(rightController.gripSpace, xrRefSpace);
      if (!pose) return;
      
      const p = pose.transform.position;
      ball.object3D.position.set(p.x, p.y, p.z);
      ballDropped = true;
      ballVelY = 0;
      log(`Ball dropped at ${p.x.toFixed(2)}, ${p.y.toFixed(2)}, ${p.z.toFixed(2)}`);
    }
    
    function resetBall() {
      if (!ball) return;
      ball.object3D.position.set(0, 2, -1);
      ballDropped = false;
      ballVelY = 0;
      log('Ball reset');
    }
    
    // Tick - update controller position and ball physics
    AFRAME.registerComponent('game-tick', {
      tick: function(time, delta) {
        const dt = Math.min(delta / 1000, 0.05);
        
        // Ball gravity
        if (ballDropped && ball) {
          ballVelY -= 9.81 * dt;
          ball.object3D.position.y += ballVelY * dt;
          
          // Floor bounce
          if (ball.object3D.position.y < 0.05) {
            ball.object3D.position.y = 0.05;
            ballVelY = -ballVelY * 0.6;
            if (Math.abs(ballVelY) < 0.3) {
              ballVelY = 0;
              ballDropped = false;
            }
          }
        }
        
        // Check gamepad buttons (A/B etc)
        if (rightController?.gamepad) {
          const gp = rightController.gamepad;
          // Button 0 = trigger, 1 = grip, 4 = A, 5 = B
          for (let i = 0; i < gp.buttons.length; i++) {
            if (gp.buttons[i].pressed) {
              log(`Gamepad btn ${i} pressed!`);
              if (!window._btnPressed) {
                window._btnPressed = true;
                dropBall();
              }
            }
          }
          if (!gp.buttons.some(b => b.pressed)) {
            window._btnPressed = false;
          }
        }
        
        // Controller tracking
        if (!inVR || !xrSession || !xrRefSpace || !rightController) return;
        
        const frame = renderer.xr?.getFrame?.();
        if (!frame) return;
        
        try {
          const pose = frame.getPose(rightController.gripSpace, xrRefSpace);
          if (pose) {
            const p = pose.transform.position;
            const q = pose.transform.orientation;
            
            // Update grip marker (green sphere)
            if (gripMarker?.object3D) {
              gripMarker.object3D.position.set(p.x, p.y, p.z);
            }
            
            // Update paddle (red box) - SAME POSITION, no offset
            if (paddle?.object3D) {
              paddle.object3D.position.set(p.x, p.y, p.z);
              paddle.object3D.quaternion.set(q.x, q.y, q.z, q.w);
            }
            
            // Show position
            log(`x:${p.x.toFixed(2)} y:${p.y.toFixed(2)} z:${p.z.toFixed(2)}`);
          }
        } catch (e) {}
      }
    });
    
    // Desktop fallback
    document.addEventListener('mousemove', e => {
      if (inVR) return;
      const x = (e.clientX / window.innerWidth - 0.5) * 2;
      const y = 0.5 + (1 - e.clientY / window.innerHeight) * 1.5;
      if (gripMarker?.object3D) gripMarker.object3D.position.set(x, y, -0.5);
      if (paddle?.object3D) paddle.object3D.position.set(x, y, -0.5);
    });
    
    document.addEventListener('click', () => { if (!inVR) dropBall(); });
    
    // Start
    document.addEventListener('DOMContentLoaded', () => {
      init();
      setTimeout(() => {
        const s = document.querySelector('a-scene');
        if (s) s.setAttribute('game-tick', '');
      }, 500);
    });
  </script>
</body>
</html>
