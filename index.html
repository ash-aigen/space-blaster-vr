<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>üèì VR Ping Pong DEBUG</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <style>
    #debug { position:fixed; top:10px; left:10px; right:10px; color:#0f0; font:14px monospace; background:rgba(0,0,0,0.9); padding:15px; border-radius:5px; z-index:9999; white-space:pre-wrap; max-height:50vh; overflow:auto; }
  </style>
</head>
<body>
  <div id="debug">Loading...</div>

  <a-scene webxr="requiredFeatures: local-floor">
    <a-sky color="#1a1a2e"></a-sky>
    <a-plane rotation="-90 0 0" width="20" height="20" color="#16213e"></a-plane>
    <a-light type="ambient" intensity="0.6"></a-light>

    <!-- Table -->
    <a-box position="0 0.76 -1.5" width="1.525" height="0.03" depth="2.74" color="#1b5e20"></a-box>

    <!-- Ball -->
    <a-sphere id="ball" radius="0.04" color="#ff9800" position="0 1 -0.5"></a-sphere>

    <!-- CPU Paddle -->
    <a-box id="cpu-paddle" position="0 0.95 -2.5" width="0.15" height="0.15" depth="0.02" color="#1565c0"></a-box>

    <!-- Player Paddle (will be moved by code) -->
    <a-box id="player-paddle" position="0 1 0" width="0.15" height="0.15" depth="0.02" color="#c62828"></a-box>

    <!-- Controller debug marker -->
    <a-sphere id="debug-marker" radius="0.05" color="#00ff00" position="0 1 0"></a-sphere>

    <!-- BIG VR Debug text -->
    <a-text id="vr-debug" value="Waiting..." position="0 2 -1.5" align="center" color="#0f0" width="4" wrap-count="60"></a-text>

    <!-- Camera -->
    <a-entity id="rig" position="0 0 1">
      <a-camera></a-camera>
    </a-entity>
  </a-scene>

  <script>
    const debugEl = document.getElementById('debug');
    const vrDebugEl = document.getElementById('vr-debug');
    let logs = [];
    
    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const line = `[${time}] ${msg}`;
      logs.unshift(line);
      logs = logs.slice(0, 20);
      debugEl.textContent = logs.join('\n');
      if (vrDebugEl) vrDebugEl.setAttribute('value', logs.slice(0, 5).join('\n'));
      console.log(line);
    }
    
    log('Script started');
    
    // State
    let inVR = false;
    let xrSession = null;
    let xrRefSpace = null;
    let rightController = null;
    let controllerPos = { x: 0, y: 1, z: 0 };
    
    // Elements
    let scene, renderer, playerPaddle, debugMarker, ball;
    
    function init() {
      scene = document.querySelector('a-scene');
      
      if (!scene) {
        log('No scene yet, waiting...');
        setTimeout(init, 200);
        return;
      }
      
      if (!scene.hasLoaded) {
        log('Scene loading...');
        scene.addEventListener('loaded', onSceneLoaded);
        return;
      }
      
      onSceneLoaded();
    }
    
    function onSceneLoaded() {
      log('Scene loaded!');
      
      playerPaddle = document.getElementById('player-paddle');
      debugMarker = document.getElementById('debug-marker');
      ball = document.getElementById('ball');
      renderer = scene.renderer;
      
      log(`Renderer: ${renderer ? 'OK' : 'MISSING'}`);
      log(`Renderer.xr: ${renderer?.xr ? 'OK' : 'MISSING'}`);
      
      scene.addEventListener('enter-vr', onEnterVR);
      scene.addEventListener('exit-vr', onExitVR);
      
      // Start tick loop
      scene.setAttribute('tick-handler', '');
      
      log('Ready! Click "Enter VR" button');
    }
    
    function onEnterVR() {
      inVR = true;
      log('=== ENTERED VR ===');
      
      const xr = renderer.xr;
      log(`renderer.xr.enabled: ${xr?.enabled}`);
      log(`renderer.xr.isPresenting: ${xr?.isPresenting}`);
      
      xrSession = xr?.getSession?.();
      log(`XR Session: ${xrSession ? 'GOT IT!' : 'NULL!'}`);
      
      if (!xrSession) {
        log('ERROR: No XR session!');
        return;
      }
      
      // Request reference space
      log('Requesting reference space...');
      xrSession.requestReferenceSpace('local-floor')
        .then(space => {
          xrRefSpace = space;
          log('Got local-floor refspace!');
        })
        .catch(e => {
          log(`local-floor failed: ${e.message}`);
          return xrSession.requestReferenceSpace('local');
        })
        .then(space => {
          if (!xrRefSpace) {
            xrRefSpace = space;
            log('Got local refspace (fallback)');
          }
        })
        .catch(e => log(`All refspace failed: ${e.message}`));
      
      // Check input sources immediately
      log(`Input sources: ${xrSession.inputSources?.length || 0}`);
      checkControllers();
      
      // Listen for changes
      xrSession.addEventListener('inputsourceschange', () => {
        log('Input sources changed!');
        checkControllers();
      });
      
      // Button events
      xrSession.addEventListener('selectstart', () => {
        log('SELECT (trigger pressed)!');
      });
      xrSession.addEventListener('squeezestart', () => {
        log('SQUEEZE (grip pressed)!');
      });
    }
    
    function onExitVR() {
      inVR = false;
      xrSession = null;
      xrRefSpace = null;
      rightController = null;
      log('Exited VR');
    }
    
    function checkControllers() {
      if (!xrSession) return;
      
      rightController = null;
      const sources = xrSession.inputSources;
      
      log(`Found ${sources.length} input source(s)`);
      
      for (let i = 0; i < sources.length; i++) {
        const src = sources[i];
        log(`  [${i}] hand=${src.handedness} mode=${src.targetRayMode} grip=${src.gripSpace ? 'YES' : 'NO'}`);
        
        if (src.handedness === 'right' && src.gripSpace) {
          rightController = src;
          log('>>> Right controller with gripSpace found!');
        }
      }
      
      if (!rightController) {
        log('WARNING: No right controller with gripSpace!');
      }
    }
    
    // A-Frame component for tick
    AFRAME.registerComponent('tick-handler', {
      tick: function(time, delta) {
        if (!inVR) return;
        if (!xrSession || !xrRefSpace || !rightController) return;
        
        // Get XR frame from renderer
        const frame = renderer.xr.getFrame?.();
        if (!frame) {
          // Only log occasionally
          if (Math.random() < 0.01) log('No XR frame');
          return;
        }
        
        // Get controller pose
        try {
          const pose = frame.getPose(rightController.gripSpace, xrRefSpace);
          
          if (pose) {
            const p = pose.transform.position;
            controllerPos = { x: p.x, y: p.y, z: p.z };
            
            // Update paddle position
            if (playerPaddle && playerPaddle.object3D) {
              playerPaddle.object3D.position.set(p.x, p.y, p.z);
            }
            
            // Update debug marker
            if (debugMarker && debugMarker.object3D) {
              debugMarker.object3D.position.set(p.x, p.y, p.z);
            }
            
            // Log position every second
            if (Math.random() < 0.02) {
              log(`Controller: x=${p.x.toFixed(2)} y=${p.y.toFixed(2)} z=${p.z.toFixed(2)}`);
            }
          } else {
            if (Math.random() < 0.01) log('getPose returned null');
          }
        } catch (e) {
          log(`Pose error: ${e.message}`);
        }
      }
    });
    
    // Desktop mouse control
    document.addEventListener('mousemove', e => {
      if (inVR) return;
      if (!playerPaddle || !playerPaddle.object3D) return;
      
      const x = (e.clientX / window.innerWidth - 0.5) * 2;
      const y = 0.7 + (1 - e.clientY / window.innerHeight) * 0.6;
      playerPaddle.object3D.position.set(x, y, 0);
      if (debugMarker) debugMarker.object3D.position.set(x, y, 0);
    });
    
    // Start
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
